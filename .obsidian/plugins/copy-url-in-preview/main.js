/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var v=Object.defineProperty;var k=Object.getOwnPropertyDescriptor;var L=Object.getOwnPropertyNames;var A=Object.prototype.hasOwnProperty;var x=(s,r)=>{for(var e in r)v(s,e,{get:r[e],enumerable:!0})},F=(s,r,e,n)=>{if(r&&typeof r=="object"||typeof r=="function")for(let t of L(r))!A.call(s,t)&&t!==e&&v(s,t,{get:()=>r[t],enumerable:!(n=k(r,t))||n.enumerable});return s};var C=s=>F(v({},"__esModule",{value:!0}),s);var H={};x(H,{default:()=>I});module.exports=C(H);var o=require("obsidian");var S=5e3;function D(s,r){let e=new Promise((n,t)=>{let i=setTimeout(()=>{clearTimeout(i),t(`timed out after ${s} ms`)},s)});return Promise.race([r,e])}async function f(s){return D(S,(()=>new Promise((e,n)=>{let t=new Image;t.crossOrigin="anonymous",t.onload=()=>{let i=document.createElement("canvas");i.width=t.width,i.height=t.height,i.getContext("2d").drawImage(t,0,0),i.toBlob(l=>{e(l)})},t.onerror=async()=>{try{await fetch(t.src,{mode:"no-cors"});let i=await f(`https://api.allorigins.win/raw?url=${encodeURIComponent(s)}`);e(i)}catch(i){n()}},t.src=s}))())}function d(s,r,e,n,t){return s.on(r,e,n,t),()=>s.off(r,e,n,t)}var w=require("obsidian"),M={pdfMenu:!0},T=class extends w.PluginSettingTab{constructor(e,n){super(e,n);this.plugin=n}display(){let{containerEl:e}=this;e.empty(),e.createEl("h3",{text:"Copy Image and URL context menu settings"}),new w.Setting(e).setName("PDF context menu").addToggle(n=>{n.setValue(this.plugin.settings.pdfMenu).onChange(t=>{this.plugin.settings.pdfMenu=t,this.plugin.saveSettings()})})}};var W="/_capacitor_file_",y=1800,U=500,R=6e4,E=100,P=5e3,I=class extends o.Plugin{constructor(){super(...arguments);this.longTapTimeoutId=null}async loadSettings(){this.settings=Object.assign({},M,await this.loadData())}async saveSettings(){this.saveData(this.settings)}async onload(){await this.loadSettings(),this.addSettingTab(new T(this.app,this)),this.registerDocument(document),app.workspace.on("window-open",(e,n)=>{this.registerDocument(n.document)})}registerDocument(e){this.register(d(e,"contextmenu","a.external-link",this.onClick.bind(this))),this.register(d(e,"mouseover",".pdf-embed iframe, .pdf-embed div.pdf-container, .workspace-leaf-content[data-type=pdf]",this.showOpenPdfMenu.bind(this))),this.register(d(e,"mousemove",".pdf-canvas",this.showOpenPdfMenu.bind(this))),o.Platform.isDesktop?(this.register(d(e,"contextmenu","img",this.onClick.bind(this))),this.register(d(e,"mouseover",".cm-link, .cm-hmd-internal-link",this.storeLastHoveredLinkInEditor.bind(this))),this.register(d(e,"mouseover","a.internal-link",this.storeLastHoveredLinkInPreview.bind(this)))):(this.register(d(e,"touchstart","img",this.startWaitingForLongTap.bind(this))),this.register(d(e,"touchend","img",this.stopWaitingForLongTap.bind(this))),this.register(d(e,"touchmove","img",this.stopWaitingForLongTap.bind(this))))}storeLastHoveredLinkInEditor(e){var p;let n=(p=app.workspace.getActiveViewOfType(o.MarkdownView))==null?void 0:p.editor;if(!n)return;let t=n.posAtMouse(e),i=n.getClickableTokenAt(t);i&&(this.lastHoveredLinkTarget=i.text)}storeLastHoveredLinkInPreview(e,n){this.lastHoveredLinkTarget=n.getAttribute("data-href")}showOpenPdfMenu(e,n){var h;if(!this.settings.pdfMenu||this.openPdfMenu||this.preventReopenPdfMenu)return;let t=n.getBoundingClientRect();if(t.left+E<e.x&&e.x<t.right-E&&t.top+E<e.y&&e.y<t.bottom-E)return;let i=n.closest(".pdf-embed"),p;if(i){let a;i.hasClass("popover")?a=this.lastHoveredLinkTarget:a=(h=i.getAttr("src"))!=null?h:this.lastHoveredLinkTarget,a=a==null?void 0:a.replace(/#page=\d+$/,"");let c=this.app.workspace.getActiveFile().path;p=this.app.metadataCache.getFirstLinkpathDest(a,c)}else p=this.app.workspace.getActiveFile();let l=new o.Menu;this.registerEscapeButton(l),l.onHide(()=>this.openPdfMenu=null),l.addItem(a=>a.setIcon("pdf-file").setTitle("Open PDF externally").onClick(async()=>{this.preventReopenPdfMenu=!0,setTimeout(()=>{this.preventReopenPdfMenu=!1},P),this.hideOpenPdfMenu(),o.Platform.isDesktop?await this.app.openWithDefaultApp(p.path):await this.app.vault.adapter.open(p.path)})),l.showAtMouseEvent(e),this.openPdfMenu=l,setTimeout(this.hideOpenPdfMenu.bind(this),P)}registerEscapeButton(e,n=activeDocument){e.register(d(n,"keydown","*",t=>{t.key==="Escape"&&(t.preventDefault(),t.stopPropagation(),e.hide())}))}hideOpenPdfMenu(){this.openPdfMenu&&this.openPdfMenu.hide()}startWaitingForLongTap(e,n){this.longTapTimeoutId?(clearTimeout(this.longTapTimeoutId),this.longTapTimeoutId=null):e.targetTouches.length==1&&(this.longTapTimeoutId=window.setTimeout(this.processLongTap.bind(this,e,n),U))}stopWaitingForLongTap(){this.longTapTimeoutId&&(clearTimeout(this.longTapTimeoutId),this.longTapTimeoutId=null)}async processLongTap(e,n){e.stopPropagation(),this.longTapTimeoutId=null;let t=this.app.vault.adapter,i=window,p=t.getFullPath(""),h=i.WEBVIEW_SERVER_URL+W+p;if(n.src.startsWith(h)){let a=n.src.replace(h,""),c=decodeURIComponent(a);await t.open(c)}else try{let a=await f(n.src);if(!a.type.startsWith("image/")){new o.Notice(`Unsupported mime type ${a.type}`);return}let c=a.type.replace("image/",""),m=`/.temp-${window.URL.createObjectURL(new Blob([])).split("/").pop()}.${c}`,u=await a.arrayBuffer();await t.writeBinary(m,u),setTimeout(()=>t.remove(m),R),new o.Notice("Image was temporarily saved and will be removed in 1 minute"),await t.open(m)}catch(a){new o.Notice("Cannot open image")}}onClick(e){e.preventDefault();let n=e.target,t=n.localName,i=new o.Menu;switch(t){case"img":{let p=n.currentSrc,l=new URL(p),h=l.protocol;switch(h){case"app:":case"data:":case"http:":case"https:":if(i.addItem(a=>a.setIcon("image-file").setTitle("Copy image to clipboard").onClick(async()=>{try{let c=await f(p),g=new ClipboardItem({[c.type]:c});await navigator.clipboard.write([g]),new o.Notice("Image copied to the clipboard!",y)}catch(c){new o.Notice("Error, could not copy the image!")}})),h==="app:"&&o.Platform.isDesktop){let c=app.vault.adapter.getFilePath("").pathname,g=l.pathname;if(g.startsWith(c)){let m=g.replace(c,"");m=decodeURI(m),i.addItem(u=>u.setIcon("arrow-up-right").setTitle("Open in default app").onClick(()=>app.openWithDefaultApp(m))),i.addItem(u=>u.setIcon("arrow-up-right").setTitle(o.Platform.isMacOS?"Reveal in finder":"Show in system explorer").onClick(()=>{app.showInFolder(m)})),i.addItem(u=>u.setIcon("folder").setTitle("Reveal file in navigation").onClick(()=>{let b=app.vault.getAbstractFileByPath(m.substring(1));app.internalPlugins.getEnabledPluginById("file-explorer").revealInFolder(b)}))}}break;default:new o.Notice(`no handler for ${h} protocol`);return}break}case"a":{let p=n.href;i.addItem(l=>l.setIcon("link").setTitle("Copy URL").onClick(()=>{navigator.clipboard.writeText(p),new o.Notice("URL copied to your clipboard",y)}));break}default:new o.Notice("No handler for this image type!");return}this.registerEscapeButton(i),i.showAtPosition({x:e.pageX,y:e.pageY}),this.app.workspace.trigger("copy-url-in-preview:contextmenu",i)}};
